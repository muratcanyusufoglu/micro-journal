# iOS Share Extension Setup Guide

## Overview

The iOS Share Extension allows users to share content from other apps (Safari, Photos, etc.) directly to OneLine. The extension files are automatically generated by the Expo Config Plugin (`plugins/withShareExtension.js`), but the Xcode target needs to be added manually **once**.

## Important Notes

⚠️ **After running `expo prebuild --clean`, you only need to add the target in Xcode ONCE. The plugin preserves the files, so you won't need to re-add the target every time.**

## Initial Setup (One-Time)

### Step 1: Run Expo Prebuild

```bash
npx expo prebuild --clean
```

This will generate the Share Extension files in `ios/OneLineShareExtension/`:
- `ShareViewController.swift`
- `Info.plist`
- `OneLineShareExtension.entitlements`

### Step 2: Add Target in Xcode (One-Time Only)

1. Open `ios/OneLine.xcworkspace` in Xcode
2. In the Project Navigator (left panel), right-click on the **OneLine** project (blue icon)
3. Select **"Add Target..."**
4. Choose **iOS** → **Share Extension**
5. Configure:
   - **Product Name:** `OneLineShareExtension`
   - **Organization Identifier:** `com.oneline`
   - **Language:** Swift
   - **Embed in Application:** OneLine
   - Click **Finish**

### Step 3: Configure Target Settings

1. Select the **OneLineShareExtension** target in Xcode
2. Go to **General** tab:
   - **Display Name:** `OneLine Share`
   - **Bundle Identifier:** `com.oneline.dailynotes.ShareExtension` (should be auto-filled)
   - **Deployment Target:** Same as main app (usually iOS 13.0+)

3. Go to **Build Settings** tab:
   - Search for "Info.plist File"
   - Set to: `OneLineShareExtension/Info.plist`

4. Go to **Signing & Capabilities** tab:
   - Select your **Team**
   - Enable **Automatically manage signing**
   - Add **App Groups** capability:
     - Click **+ Capability**
     - Add **App Groups**
     - Check `group.com.oneline.dailynotes`

### Step 4: Add Files to Target

1. In Project Navigator, find `ios/OneLineShareExtension/` folder
2. Select all files (`ShareViewController.swift`, `Info.plist`, `OneLineShareExtension.entitlements`)
3. In File Inspector (right panel), under **Target Membership**, check **OneLineShareExtension**

### Step 5: Build and Test

1. In Xcode, select **OneLineShareExtension** scheme (or "OneLine" to build both)
2. Build (⌘B)
3. Run on device or simulator
4. Test by sharing from Safari or Photos app

## How It Works

1. **Share Extension receives content** (text, URL, images)
2. **Processes attachments** using `UTType` identifiers
3. **Saves images to App Group** (shared storage between extension and main app)
4. **Opens main app** via deep link: `oneline://capture?text=...&url=...&imageUris=...`
5. **Main app receives URL** via `useDeepLinking` hook
6. **Navigates to capture screen** with shared data

## Troubleshooting

### Share Extension Not Appearing

- Make sure target is added and built
- Check that `Info.plist` has correct `NSExtensionPrincipalClass`
- Verify Bundle Identifier is correct
- Restart device/simulator

### Content Not Saving

- Check Xcode console for Share Extension logs
- Verify deep link URL is being created correctly
- Check Metro bundler console for "Deep Linking: Received capture URL"
- Ensure `useDeepLinking` hook is active in `app/_layout.tsx`

### Files Disappear After Prebuild

The plugin now preserves files if they exist and haven't changed. However, if you manually modify files and they conflict with the plugin's expected content, they may be overwritten.

**Solution:** If you need to customize files, modify the plugin (`plugins/withShareExtension.js`) instead of the generated files directly.

## Maintenance

- **After `expo prebuild --clean`:** Files are preserved, target stays in Xcode
- **If target disappears:** Re-add it following Step 2 (should be rare)
- **To update Share Extension code:** Modify `plugins/withShareExtension.js` and run `expo prebuild`

## Files Generated by Plugin

- `ios/OneLineShareExtension/ShareViewController.swift` - Main extension logic
- `ios/OneLineShareExtension/Info.plist` - Extension configuration
- `ios/OneLineShareExtension/OneLineShareExtension.entitlements` - App Groups capability

These files are automatically created/updated by the plugin, but the Xcode target must be added manually once.
